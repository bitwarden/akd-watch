services:
  akd-watch-auditor:
    build:
      context: ..
      dockerfile: docker/Dockerfile.auditor
    image: akd-watch/auditor:latest
    environment:
      - AKD_WATCH_CONFIG_PATH=/etc/akd-watch/config
    volumes:
      # Configuration file
      - ./config.toml:/etc/akd-watch/config.toml:ro
      # Shared persistent storage volumes
      - akd-watch-data:/var/lib/akd-watch/data
      - akd-watch-keys:/var/lib/akd-watch/keys
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  akd-watch-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    image: akd-watch/web:latest
    ports:
      - "8081:8080"
    environment:
      - AKD_WATCH_CONFIG_PATH=/etc/akd-watch/config
    volumes:
      # Configuration file
      - ./config.toml:/etc/akd-watch/config.toml:ro
      # Shared persistent storage volumes (same as auditor)
      - akd-watch-data:/var/lib/akd-watch/data
      - akd-watch-keys:/var/lib/akd-watch/keys:ro  # Web only needs read access to keys
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

# Named volumes for persistent data sharing between services
volumes:
  akd-watch-data:
    driver: local
    # Stores namespace state and signature files
  akd-watch-keys:
    driver: local
    # Stores signing/verifying keys
